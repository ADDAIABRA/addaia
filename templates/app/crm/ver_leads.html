{% extends 'app/base.html' %}
{% load static %}

{% block css_lib %}
<link rel="stylesheet" href="{% static 'app/modules/datatables/datatables.min.css' %}">
<link rel="stylesheet" href="{% static 'app/modules/datatables/DataTables-1.10.16/css/dataTables.bootstrap4.min.css' %}">
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h4>Meus Leads</h4>
                <div class="card-header-action d-flex align-items-center">
                    <div class="dropdown mr-2">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="btnColunas" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <i class="fas fa-columns"></i> Colunas
                        </button>
                        <div class="dropdown-menu dropdown-menu-right p-3" id="dropdownColunas" style="min-width: 200px;">
                            <p class="text-muted small mb-2">Exibir colunas:</p>
                            <div class="form-check">
                                <input class="form-check-input col-toggle" type="checkbox" id="col-0" data-col="0">
                                <label class="form-check-label" for="col-0">Categoria</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input col-toggle" type="checkbox" id="col-1" data-col="1">
                                <label class="form-check-label" for="col-1">Cidade</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input col-toggle" type="checkbox" id="col-2" data-col="2">
                                <label class="form-check-label" for="col-2">Bairro</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input col-toggle" type="checkbox" id="col-3" data-col="3">
                                <label class="form-check-label" for="col-3">Nome</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input col-toggle" type="checkbox" id="col-4" data-col="4">
                                <label class="form-check-label" for="col-4">Telefone</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input col-toggle" type="checkbox" id="col-5" data-col="5">
                                <label class="form-check-label" for="col-5">Endereço</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input col-toggle" type="checkbox" id="col-6" data-col="6">
                                <label class="form-check-label" for="col-6">Site</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input col-toggle" type="checkbox" id="col-7" data-col="7">
                                <label class="form-check-label" for="col-7">Nota</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input col-toggle" type="checkbox" id="col-8" data-col="8">
                                <label class="form-check-label" for="col-8">Avaliações</label>
                            </div>
                        </div>
                    </div>
                    <a href="{% url 'export_leads_csv' %}" class="btn btn-outline-success mr-2" title="Exportar para CSV">
                        <i class="fas fa-file-alt"></i> CSV
                    </a>
                    <a href="{% url 'export_leads_excel' %}" class="btn btn-outline-success mr-2" title="Exportar para Excel">
                        <i class="fas fa-file-excel"></i> Excel
                    </a>
                    <a href="{% url 'coletar_leads' %}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Coletar mais leads
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="leadsTable" class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Categoria</th>
                                <th>Cidade</th>
                                <th>Bairro</th>
                                <th>Nome</th>
                                <th>Telefone</th>
                                <th>Endereço</th>
                                <th>Site</th>
                                <th>Nota</th>
                                <th>Avaliações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for lead in leads %}
                            <tr>
                                <td>{{ lead.categoria|default:"-" }}</td>
                                <td>{{ lead.cidade|default:"-" }}</td>
                                <td>{{ lead.bairro|default:"-" }}</td>
                                <td>{{ lead.nome }}</td>
                                <td>{{ lead.telefone|default:"-" }}</td>
                                <td>{{ lead.endereco|default:"-"|truncatewords:8 }}</td>
                                <td>{% if lead.site %}<a href="{{ lead.site }}" target="_blank" rel="noopener">{{ lead.site|truncatechars:30 }}</a>{% else %}-{% endif %}</td>
                                <td>{{ lead.nota|default:"-" }}</td>
                                <td>{{ lead.total_avaliacoes|default:0 }}</td>
                            </tr>
                            {% empty %}
                            <tr id="empty-row">
                                <td colspan="9" class="text-center text-muted">Nenhum lead coletado ainda.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% if coleta and coleta.status == 'em_andamento' %}
<!-- Modal: Coletando leads (fechado via JS quando coleta concluir) -->
<div class="modal fade" id="modalColetando" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-spinner fa-spin mr-2"></i> Coletando leads...
                </h5>
            </div>
            <div class="modal-body text-center">
                <p>Aguarde enquanto buscamos os leads conforme seus critérios.</p>
                <p class="text-muted mb-0">A tabela será atualizada automaticamente.</p>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block js_lib %}
<script src="{% static 'app/modules/datatables/datatables.min.js' %}"></script>
<script src="{% static 'app/modules/datatables/DataTables-1.10.16/js/dataTables.bootstrap4.min.js' %}"></script>
{% endblock %}

{% block js_page %}
<script>
$(document).ready(function() {
    var STORAGE_KEY = 'ver_leads_columns';
    var COLUMN_NAMES = ['Categoria', 'Cidade', 'Bairro', 'Nome', 'Telefone', 'Endereço', 'Site', 'Nota', 'Avaliações'];

    function getSavedColumns() {
        try {
            var saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                var arr = JSON.parse(saved);
                if (Array.isArray(arr) && arr.length === 9) return arr;
            }
        } catch (e) {}
        return [true, true, true, true, true, true, true, true, true];
    }

    function saveColumns(visibility) {
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(visibility));
        } catch (e) {}
    }

    var savedVisibility = getSavedColumns();
    var columnDefs = COLUMN_NAMES.map(function(_, i) {
        return { visible: savedVisibility[i] };
    });

    var table = $('#leadsTable').DataTable({
        language: {
            emptyTable: 'Nenhum registro encontrado',
            info: 'Mostrando de _START_ até _END_ de _TOTAL_ registros',
            infoEmpty: 'Mostrando 0 até 0 de 0 registros',
            infoFiltered: '(Filtrados de _MAX_ registros)',
            lengthMenu: '_MENU_ registros por página',
            loadingRecords: 'Carregando...',
            processing: 'Processando...',
            search: 'Buscar:',
            zeroRecords: 'Nenhum registro encontrado',
            paginate: {
                first: 'Primeiro',
                last: 'Último',
                next: 'Próximo',
                previous: 'Anterior'
            }
        },
        order: [[3, 'asc']],
        pageLength: 5,
        lengthMenu: [5, 10, 25, 50, 100],
        columnDefs: columnDefs
    });

    function updateCheckboxes() {
        for (var i = 0; i < 9; i++) {
            $('#col-' + i).prop('checked', table.column(i).visible());
        }
    }
    updateCheckboxes();

    $(document).on('change', '.col-toggle', function() {
        var colIndex = parseInt($(this).data('col'), 10);
        var visible = $(this).prop('checked');
        var visibleCount = 0;
        for (var i = 0; i < 9; i++) {
            if (table.column(i).visible()) visibleCount++;
        }
        if (!visible && visibleCount <= 1) return;
        table.column(colIndex).visible(visible);
        var newVisibility = [];
        for (var j = 0; j < 9; j++) newVisibility.push(table.column(j).visible());
        saveColumns(newVisibility);
    });

    $('#dropdownColunas').on('click', function(e) {
        e.stopPropagation();
    });

    {% if coleta and coleta.status == 'em_andamento' %}
    $('#modalColetando').modal('show');
    var coletaId = {{ coleta.id }};
    var lastId = 0;
    var pollInterval;

    function pollLeads() {
        var url = '{% url "leads_stream" 0 %}'.replace('0', coletaId);
        if (lastId > 0) {
            url += '?since_id=' + lastId;
        }
        fetch(url, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.leads && data.leads.length > 0) {
                $('#empty-row').remove();
                data.leads.forEach(function(lead) {
                    var siteCell = lead.site ? '<a href="' + lead.site + '" target="_blank" rel="noopener">' + (lead.site.length > 30 ? lead.site.substring(0, 30) + '...' : lead.site) + '</a>' : '-';
                    table.row.add([
                        lead.categoria || '-',
                        lead.cidade || '-',
                        lead.bairro || '-',
                        lead.nome,
                        lead.telefone || '-',
                        lead.endereco ? (lead.endereco.length > 50 ? lead.endereco.substring(0, 50) + '...' : lead.endereco) : '-',
                        siteCell,
                        lead.nota || '-',
                        lead.total_avaliacoes || 0
                    ]);
                    if (lead.id > lastId) lastId = lead.id;
                });
                table.draw(false);
            }
            if (data.coleta_status === 'concluida' || data.coleta_status === 'erro') {
                clearInterval(pollInterval);
                var $m = $('#modalColetando');
                if ($m.length) {
                    $m.modal('hide');
                    $m.addClass('d-none').hide();
                    $('.modal-backdrop').remove();
                    $('body').removeClass('modal-open').css('padding-right', '');
                }
            }
        })
        .catch(function(err) {
            console.warn('Poll error:', err);
        });
    }

    pollInterval = setInterval(pollLeads, 2000);
    pollLeads();
    {% endif %}
});
</script>
{% endblock %}
